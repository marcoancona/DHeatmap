<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="UTF-8">
		<title>Dheatmap by marcoancona</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="stylesheets/stylesheet.css">
		<style>
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
			#map {
				height: 100%;
			}
		</style>
		<!-- Change the key with your own! -->
		<!-- Public key only working on marcoancona.github.io: AIzaSyBoWz0asV3T_E8cXevq2SauTkhWJpYyWnQ -->
		<!-- <script src="https://maps.googleapis.com/maps/api/js"></script> -->
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBoWz0asV3T_E8cXevq2SauTkhWJpYyWnQ"></script>
		<script>
			// This example creates a custom overlay called USGSOverlay, containing
			// a U.S. Geological Survey (USGS) image of the relevant area on the map.

			// Set the custom overlay object's prototype to a new instance
			// of OverlayView. In effect, this will subclass the overlay class therefore
			// it's simpler to load the API synchronously, using
			// google.maps.event.addDomListener().
			// Note that we set the prototype to an instance, rather than the
			// parent class itself, because we do not wish to modify the parent class.

			var overlay;
			USGSOverlay.prototype = new google.maps.OverlayView();

			// Load images
			var srcImageBest = 'https://marcoancona.github.io/DHeatmap/' +
					'1000.best.png';
			var srcImageRandom = 'https://marcoancona.github.io/DHeatmap/' +
					'1000.random.png';

			function toMode(m) {
				var imgHeatmap = document.getElementById('heatmap');
				imgHeatmap.src = m == 1 ? srcImageBest : srcImageRandom;
			}

			// Initialize the map and the custom overlay.
			function initMap() {
				var map = new google.maps.Map(document.getElementById('map'), {
					zoom: 14,
					center: {lat: 47.38, lng: 8.54},
					mapTypeId: 'roadmap'
				});

				var marker = new google.maps.Marker({
						position: {lat: 47.376536, lng: 8.548093},
						map: map,
						title: 'ETH Zurich'
					});

				var legend = document.getElementById('legend');
				legend.style.margin = '5px'
				var metadata = JSON.parse(getUrl('https://marcoancona.github.io/DHeatmap/1000.best.metadata.json'))

				for (var i = 0; i < metadata.buckets.length; i++) {
					bucket = i > 0 ? '< ' + metadata.buckets[i-1] : '60+';
					color = metadata.colors[i];
					var div = document.createElement('div');
					div.style["background-color"] = 'rgb(' + color.join(',') + ')';
					div.innerHTML = bucket + ' min';
					legend.appendChild(div);
				}

				map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);

				// Mode switch
				var modeSwitch = document.getElementById('mode');
				map.controls[google.maps.ControlPosition.TOP_LEFT].push(modeSwitch);

				var bounds = new google.maps.LatLngBounds(
						new google.maps.LatLng(47.348825982085685, 8.438186645507812),
						new google.maps.LatLng(47.438538059325126, 8.599891662597656));

				// The custom USGSOverlay object contains the USGS image,
				// the bounds of the image, and a reference to the map.
				overlay = new USGSOverlay(bounds, srcImageBest, map);
			}

			function getUrl (url) {
				var Httpreq = new XMLHttpRequest(); // a new request
				Httpreq.open("GET", url, false);
				Httpreq.send(null);
				return Httpreq.responseText;
			}
			/** @constructor */
			function USGSOverlay(bounds, image, map) {

				// Initialize all properties.
				this.bounds_ = bounds;
				this.image_ = image;
				this.map_ = map;

				// Define a property to hold the image's div. We'll
				// actually create this div upon receipt of the onAdd()
				// method so we'll leave it null for now.
				this.div_ = null;

				// Explicitly call setMap on this overlay.
				this.setMap(map);
			}

			/**
			 * onAdd is called when the map's panes are ready and the overlay has been
			 * added to the map.
			 */
			USGSOverlay.prototype.onAdd = function() {

				var div = document.createElement('div');
				div.style.borderStyle = 'none';
				div.style.borderWidth = '0px';
				div.style.position = 'absolute';

				// Create the img element and attach it to the div.
				var img = document.createElement('img');
				img.id = 'heatmap';
				img.src = this.image_;
				img.style.width = '100%';
				img.style.height = '100%';
				img.style.position = 'absolute';
				img.style.opacity = '0.6';
				div.appendChild(img);

				this.div_ = div;

				// Add the element to the "overlayLayer" pane.
				var panes = this.getPanes();
				panes.overlayLayer.appendChild(div);
			};

			USGSOverlay.prototype.draw = function() {

				// We use the south-west and north-east
				// coordinates of the overlay to peg it to the correct position and size.
				// To do this, we need to retrieve the projection from the overlay.
				var overlayProjection = this.getProjection();

				// Retrieve the south-west and north-east coordinates of this overlay
				// in LatLngs and convert them to pixel coordinates.
				// We'll use these coordinates to resize the div.
				var sw = overlayProjection.fromLatLngToDivPixel(this.bounds_.getSouthWest());
				var ne = overlayProjection.fromLatLngToDivPixel(this.bounds_.getNorthEast());

				// Resize the image's div to fit the indicated dimensions.
				var div = this.div_;
				div.style.left = sw.x + 'px';
				div.style.top = ne.y + 'px';
				div.style.width = (ne.x - sw.x) + 'px';
				div.style.height = (sw.y - ne.y) + 'px';
			};

			// The onRemove() method will be called automatically from the API if
			// we ever set the overlay's map property to 'null'.
			USGSOverlay.prototype.onRemove = function() {
				this.div_.parentNode.removeChild(this.div_);
				this.div_ = null;
			};

			google.maps.event.addDomListener(window, 'load', initMap);
		</script>
	</head>
	<body>
		<div id="map"></div>
		<div id="legend"><h3>Legend</h3></div>
		<div id="mode">
			<nav class="segmented-button">
				<input type="radio" name="seg-1" value="Best" id="seg-best" onclick="toMode(1)" checked="checked">
				<label for="seg-best">Best departure</label>
				<input type="radio" name="seg-1" value="Random" id="seg-random" onclick="toMode(2)">
				<label for="seg-random">Random departure</label>
			</nav>
		</div>
		<footer class="site-footer">
			<span class="site-footer-owner"><a href="https://github.com/marcoancona/DHeatmap">Dheatmap</a> is maintained by <a href="https://github.com/marcoancona">marcoancona</a>.</span>
		</footer>
	</body>
</html>
